name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  ACCEPT_EULA: Y
  SQL_PASSWORD: P@ssword123!
  SAS_KEY_VALUE: LocalEmulatorKey123!
  EMULATOR_HTTP_PORT: 5300

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.0.x

      - name: Set up .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            9.0.x

      - name: Start Service Bus emulator
        run: |
          docker compose -f docker-compose.sbus.yml up -d

      - name: Wait for emulator health
        run: |
          for i in {1..60}; do
            if curl -fsS http://localhost:${EMULATOR_HTTP_PORT}/health >/dev/null 2>&1; then
              echo "Emulator ready."
              exit 0
            fi
            sleep 2
          done
          echo "Emulator not ready in time" >&2
          docker compose -f docker-compose.sbus.yml logs
          exit 1

      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore

      - name: Run integration tests
        run: dotnet test tests/SBPowerShell.IntegrationTests/SBPowerShell.IntegrationTests.csproj --no-build

      - name: Run Pester tests
        shell: pwsh
        run: |
          Invoke-Pester -Script tests/SBPowerShell.Tests.ps1 -EnableExit
